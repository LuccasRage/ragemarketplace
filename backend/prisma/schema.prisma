// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPPORT
}

enum Age {
  NEWBORN
  JUNIOR
  PRE_TEEN
  TEEN
  POST_TEEN
  FULL_GROWN
}

enum Potion {
  NONE
  FLY
  RIDE
  FLY_RIDE
}

enum Rarity {
  NORMAL
  NEON
  MEGA_NEON
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
}

enum OrderStatus {
  PENDING_DELIVERY
  DELIVERED
  CONFIRMED
  DISPUTED
  REFUNDED
  COMPLETED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PURCHASE
  SALE_EARNING
  ESCROW_HOLD
  ESCROW_RELEASE
  REFUND
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_BUYER
  RESOLVED_SELLER
  CLOSED
}

model User {
  id              String   @id @default(uuid())
  username        String   @unique
  email           String   @unique
  password        String
  robloxUsername  String?
  avatarUrl       String?
  balance         Decimal  @default(0.00) @db.Decimal(10, 2)
  frozenBalance   Decimal  @default(0.00) @db.Decimal(10, 2)
  role            Role     @default(USER)
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  listings        Listing[]
  buyerOrders     Order[]       @relation("BuyerOrders")
  sellerOrders    Order[]       @relation("SellerOrders")
  transactions    Transaction[]
  disputesOpened  Dispute[]     @relation("DisputeOpener")
  reviewsGiven    Review[]      @relation("Reviewer")
  reviewsReceived Review[]      @relation("Seller")

  @@index([username])
  @@index([email])
}

model Listing {
  id          String        @id @default(uuid())
  sellerId    String
  petName     String
  petCategory String
  age         Age
  potion      Potion        @default(NONE)
  rarity      Rarity        @default(NORMAL)
  price       Decimal       @db.Decimal(10, 2)
  description String        @db.Text
  imageUrl    String?
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  seller User    @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([sellerId])
  @@index([status])
  @@index([petCategory])
}

model Order {
  id                  String      @id @default(uuid())
  listingId           String
  buyerId             String
  sellerId            String
  price               Decimal     @db.Decimal(10, 2)
  platformFee         Decimal     @db.Decimal(10, 2)
  sellerEarnings      Decimal     @db.Decimal(10, 2)
  status              OrderStatus @default(PENDING_DELIVERY)
  escrowAmount        Decimal     @db.Decimal(10, 2)
  buyerConfirmedAt    DateTime?
  sellerDeliveredAt   DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relations
  listing      Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer        User          @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  seller       User          @relation("SellerOrders", fields: [sellerId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  dispute      Dispute?
  review       Review?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Transaction {
  id              String          @id @default(uuid())
  userId          String
  type            TransactionType
  amount          Decimal         @db.Decimal(10, 2)
  balanceBefore   Decimal         @db.Decimal(10, 2)
  balanceAfter    Decimal         @db.Decimal(10, 2)
  description     String
  relatedOrderId  String?
  createdAt       DateTime        @default(now())

  // Relations
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  relatedOrder Order? @relation(fields: [relatedOrderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([relatedOrderId])
}

model Dispute {
  id         String        @id @default(uuid())
  orderId    String        @unique
  openedById String
  reason     String        @db.Text
  proofUrls  String[]
  status     DisputeStatus @default(OPEN)
  adminNotes String?       @db.Text
  resolvedAt DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  openedBy User  @relation("DisputeOpener", fields: [openedById], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model Review {
  id         String   @id @default(uuid())
  orderId    String   @unique
  reviewerId String
  sellerId   String
  rating     Int
  comment    String   @db.Text
  createdAt  DateTime @default(now())

  // Relations
  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewer User  @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  seller   User  @relation("Seller", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([sellerId])
}
